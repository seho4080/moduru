server {
    listen 80;
    server_name moduru.co.kr 3.34.53.245;

    # HTTP â†’ HTTPS ë¦¬ë‹¤ì´ë ‰íŠ¸ (SSL ì“¸ ê²½ìš°)
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name moduru.co.kr 3.34.53.245;

    # SSL ì¸ì¦ì„œ ìœ„ì¹˜ (Let's Encrypt ê¸°ì¤€)
    ssl_certificate     /etc/letsencrypt/live/moduru.co.kr/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/moduru.co.kr/privkey.pem;

    # ë³´ì•ˆ ì˜µì…˜
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_session_cache   shared:SSL:10m;


    # 1. í”„ë¡ íŠ¸ ì •ì  íŒŒì¼ (React/Vite ë¹Œë“œ ê²°ê³¼)
    location / {
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;
        index index.html; # index ì§€ì‹œë¬¸ ì¶”ê°€

        # ìºì‹œ ë¬´íš¨í™” (ê¸°ì¡´ 4ë²ˆ ë¸”ë¡ ë‚´ìš©)
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires 0;
    }
}

    # 4. RTC ì—°ê²° 
    location = /livekit { return 301 /livekit/; }
    location /livekit/ {
        proxy_pass http://livekit:7880/;   # â† ëì— / ë¡œ prefix ì œê±°!
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto https;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
        proxy_buffering off;
    }

    # 2. WebSocket í”„ë¡ì‹œ
    location /api/ws-stomp/ {
        proxy_pass http://backend:8080/ws-stomp/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;

    }
    # 3. Spring Boot ë°±ì—”ë“œ API í”„ë¡ì‹œ
    location /api/ {
        proxy_pass http://backend:8080/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Cookie $http_cookie;
        # ì„ì‹œë¡œ location ì•ˆì— ì¶”ê°€
        proxy_set_header X-Original-URI $request_uri;


    }


    # (Node.js ì†Œì¼“ í”„ë¡ì‹œëŠ” ë‚˜ì¤‘ì— í•„ìš”í•  ë•Œë§Œ ì£¼ì„ í•´ì œ)
    location = /api/signal/token {
        proxy_pass http://node-backend:4000/get-token;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;   # ğŸ”¹ ì›ë³¸ í”„ë¡œí† ì½œ ì „ë‹¬
        proxy_set_header Cookie $http_cookie;   # â† ì´ê±° ì¶”ê°€!
        proxy_read_timeout 30s;                     # ğŸ”¹ í† í° ë°œê¸‰ ì§€ì—° ëŒ€ë¹„
        
    }

    location /livekit/webhook {
        proxy_pass http://node-backend:4000/livekit/webhook;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        client_max_body_size 2m;                    # ğŸ”¹ í˜¹ì‹œ ëª¨ë¥¼ í˜ì´ë¡œë“œ ëŒ€ë¹„
    }
}